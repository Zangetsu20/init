{% extends 'base.html' %}

{% block title %}

{% endblock %}

{% block content %}

{% for teacher in teachers %}
<div class="item1" data-id="{{ teacher.id }}">
    <div class="item-in2">  
        <span class="first-name2"               
              data-field="first_name">{{ teacher.first_name }}</span>
        
        <span class="last-name2" 
              data-field="last_name">{{ teacher.last_name }}</span>
    </div>
</div>

{% endfor %}
---------------------------

<table class="teachers-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Фамилия</th>
        <th>Имя</th>
      </tr>
    </thead>
    <tbody>
      {% for teacher in teachers %}
      <tr>
        <td>{{ teacher.id }}</td>
        <td contenteditable="true" 
            data-field="last_name" 
            data-id="{{ teacher.id }}">
          {{ teacher.last_name }}
        </td>
        <td contenteditable="true" 
            data-field="first_name" 
            data-id="{{ teacher.id }}">
          {{ teacher.first_name }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  <script>
document.querySelectorAll('[contenteditable]').forEach(element => {
        // Сохраняем исходное значение при фокусе
element.addEventListener('focus', function() {this.dataset.originalValue = this.innerText;  });

element.addEventListener('keydown', async function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    this.blur(); // Снимаем фокус с элемента
                
    const id = this.closest('[data-id]').dataset.id;
    const field = this.dataset.field;
    const newValue = this.innerText.trim();

    // Проверка данных
    if (!id || !field || newValue === undefined) {
      console.error("Отсутствуют необходимые данные:", {id, field, newValue});
      this.innerText = this.dataset.originalValue;
      return;
    }

    // Визуальный фидбек - желтый фон на время запроса
    this.style.backgroundColor = '#fff9e6';
                
    try {
      const response = await fetch('/update_teacher', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json'},
        body: JSON.stringify({
          id: id,
          field: field,
          value: newValue
          })
      });

    if (!response.ok) {
      throw new Error(await response.text());
    }

    // Успешное обновление - зеленый фон
    this.style.backgroundColor = '#e6ffe6';
    setTimeout(() => this.style.backgroundColor = '', 1000);

    // Обновляем все аналогичные элементы на странице
    document.querySelectorAll(`[data-id="${id}"] [data-field="${field}"]`)
  .forEach(el => el.innerText = newValue);

    } catch (error) {
      console.error("Ошибка:", error);
      this.innerText = this.dataset.originalValue;
      this.style.backgroundColor = '#ffe6e6'; // Красный фон при ошибке
      setTimeout(() => this.style.backgroundColor = '', 1000);
      }
  }
});

        // Отмена редактирования при Escape
  element.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    this.innerText = this.dataset.originalValue;
    this.blur();
  }
  });
});
  </script>
{% endblock %}